<html>
<head>
<style>
#container {
	overflow: hidden;
	border: 1px solid black;
	width:1080;
}
#container div {
	float:left;
}

</style>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="http://d3lp1msu2r81bx.cloudfront.net/kjs/js/lib/kinetic-v5.0.1.js"></script>
</head>
<body>
<div id = "container">
<div id = "selt"></div>
<div id = "editBox"><div>
</div>

<script>

var mainStage = new Kinetic.Stage({
width: 400,
height: 400,
container: 'selt'
});

var editStage = new Kinetic.Stage({
width: 680,
height: 400,
container: 'editBox'
});

var mainBoardLayer = new Kinetic.Layer({
});

var editSequencesLayer = new Kinetic.Layer({
});

var rect = new Kinetic.Rect({
width: 400,
height: 400, 
id: "re1",
fill: 'green',
stroke: 'black',
strokeWidth: 5,

});

var rectSmall = new Kinetic.Rect({
width: 200,
height: 200, 
id: "re1",
fill: 'green',
stroke: 'black',
strokeWidth: 5,

});

var sceneTitle = new Kinetic.Text({
	    x: 400,
        y: 200,
        fontSize: 18,
        fontFamily: 'Courier',
        fill: '#555',
        width: 380

});

var offColor = "gray";
var onColor = "white";
var board = new Kinetic.Group({
	width:400,
	height:400
});
var boardScene1 = new Kinetic.Group({
	draggable:true,
	x: 500,
	y: 500
});
board.add(rect);
boardScene1.add(rectSmall);
var led = [];



var x = [];
var names = ["led2", "led3", "led4", "led5", "led6", "led7", "led8", "led9", "led10", "led11", "led12", "led13", "led14", "led15"];
function setupLeds(groupName) {
	var rad = (groupName.getWidth() / (26 + (2 / 3)));
	console.log(rad);
	for(var i = 1; i <= 14; i++) {
		(function() {
			var n = i;
			var led = new Kinetic.Circle({
			radius: rad,
			x: rad * 3,
			y: 20 + (5 * i),
			fill: offColor,
			id: names[i-1],
			stroke: "black",
			strokeWidth: 4,
			state:0,
			draggable: true
			});
				
		groupName.add(led);

		})();
	}
}

function changeLedPositions() {
	for(var k = 1; k <= 14; k++) {
		for(var j = 0; j < scenes.length; j++) {
			editSequencesLayer.find(".Board" + names[k-1])[j].setX(((board.find("#"+names[k - 1])[0].getX()) * editSequencesLayer.find("#scene" + j)[0].getWidth()) / board.getWidth());
			editSequencesLayer.find(".Board" + names[k-1])[j].setY(((board.find("#"+names[k - 1])[0].getY()) * editSequencesLayer.find("#scene" + j)[0].getWidth()) / board.getWidth());
		}
	}
}

function setupScenes() {
	for(var j = 0; j < scenes.length; j++) {
		(function() {
			var i = j;
			var sceneWidth = 100;
			var sceneHolder = new Kinetic.Group({
				id: "scene"+i,
				x: (sceneWidth / 2) + (((sceneWidth / 2) * (5/2)) * i),
				y: (sceneWidth / 2),
				stroke: "black",
				strokeWidth: 3,
				width: sceneWidth,
				height: sceneWidth
			});

			var sceneNumber = new Kinetic.Text({
			fontSize: 32,
			fontFamily: 'Arial',
			fill: '#EEE',
			width: 380,
			text: (i)
			});
			
			var rad = (sceneHolder.getWidth() / (26 + (2 / 3)));
			console.log(rad);

			
			var sceneBox = new Kinetic.Rect({
				width: sceneWidth, 
				height: sceneWidth,
				fill: "green",
				id: "scene"+i+"Box"
			});
			
			sceneHolder.add(sceneBox);
			sceneHolder.add(sceneNumber);
			
			for(var k = 1; k <= 14; k++) {
				(function() {
					var n = k;
					var led = new Kinetic.Circle({
					radius: rad,
					x: board.find("#"+names[n - 1])[0].getX(),
					y: board.find("#"+names[n - 1])[0].getY(),
					fill: offColor,
					name: "Board"+names[k-1],
					stroke: "black",
					strokeWidth: 2,
					state:0,
					draggable: true
					});
						
				sceneHolder.add(led);

				})();
			}
			
			editSequencesLayer.add(sceneHolder);

			editSequencesLayer.find("#scene"+i).on("click", function() {
				changeScene(i);	
				if(i == currentSceneId) {
					editSequencesLayer.find("#scene"+i+"Box").setFill("red");
				}
			});
			editSequencesLayer.find("#scene"+i).on("mouseover", function() {
				editSequencesLayer.find("#scene"+i+"Box").setFill("blue");
			});

			editSequencesLayer.find("#scene"+i).on("mouseout", function() {

				editSequencesLayer.find("#scene"+i+"Box").setFill("green");

			});

		})();
	}
}

function setupLedEvents() {
	for( var j = 0; j <= 13; j++ ) {
		(function() {
			var i = j;
			board.find("#"+names[i]).on("mousedown", function() {
				if(mode == "EDIT") {
					if(scenes[currentSceneId].ledStates[i] == 0) {
						scenes[currentSceneId].ledStates[i] = 1;
						console.log(names[i]);
						console.log("x: " + board.find("#"+names[i])[0].getX());
						console.log("y: " + board.find("#"+names[i])[0].getY());
					} 
					else {
						scenes[currentSceneId].ledStates[i] = 0;
					}
				}
			});
		})();
	}
}

function main() {
	setupLeds(board);
	setupLedEvents();
	setupScenes();	
	updateSceneLeds(scenes[currentSceneId], board);
	//playCurrentSequence();
	setInterval(tickStart, 100);
}

function Scene(sceneId, ledStates) {
	this.sceneId = sceneId;
	this.ledStates = ledStates;
}

function Sequence(sequenceId, sceneN, selector){
	this.sequenceId = sequenceId;
	this.sceneN = sceneN;
	this.selector = selector;
}


var mode = "EDIT";
var currentSceneId = 0;
var currentSequenceId = 0;
var curTime = 0;
var delayStep = 100;
var delayScale = 1000;
var delayVal = 0.8 * delayScale;
var curIdx = 0;
var scenes = [];

scenes[0] = new Scene(0, [0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 1]);
scenes[1] = new Scene(1, [0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 1, 0]);
scenes[2] = new Scene(2, [1, 0, 1, 1, 0, 0, 1, 0, 1, 0, 0, 0, 0, 1]);
var sequences = [];
sequences[0] = new Sequence(0, [0, 1, 2, 1, 0, 2], 1);
sequences[1] = new Sequence(0, [1, 2, 0], 2);



function playCurrentSequence() {
	mode = "PLAY";
}

function editCurrentSequence() {
	mode = "EDIT";

}

function updateSceneLeds(sceneNum, boardNum) {

	for( var j = 0; j < sceneNum.ledStates.length; j++) {
		if(sceneNum.ledStates[j] == 1) {
			ledOn(j + 2, boardNum);
		} else {
			ledOff(j + 2, boardNum);
		}
	}
	
}                        


function updateSequenceScenes() {
	currentSceneId = sequences[currentSequenceId].sceneN[sequences[currentSequenceId].selector];
	console.log("Selector is: " + sequences[currentSequenceId].selector);
}         

//setLeds();

function tickStart() {
	//console.log("tickStart() reached");
	if(curTime < delayVal) {
     curTime += delayStep;
	 //console.log("curTime is " + curTime);
	 return;
	}

	if(mode == "PLAY") {
		console.log("Play Mode");
		if(curIdx < (sequences[currentSequenceId].sceneN.length - 1)) {
			curIdx += 1;

		}
		else {
			curIdx = 0;
		}
		sequences[currentSequenceId].selector = curIdx;
		updateSequenceScenes();
	}
	updateSceneLeds(scenes[currentSceneId], board);
	curTime = 0;
}

var anim = new Kinetic.Animation(function(frame) {

if(mode == "EDIT") {
	updateSceneLeds(scenes[currentSceneId], board);
}
sceneTitle.setText("Current Scene: " + currentSceneId);


}, mainBoardLayer);
anim.start();

var anim2 = new Kinetic.Animation(function(frame) {
	//setupScenes();
	changeLedPositions();
	for(var i = 0; i < scenes.length; i++) {
		//updateSceneLeds(i, board);
		//console.log(i);
	}
}, editSequencesLayer);
anim2.start();

function ledOn(ledNum, boardNum) {
	var e = boardNum.find("#" + names[ledNum - 2]);
	e.setFill(onColor);
	led[ledNum] = 1;
	//console.log(names[ledNum - 2] + " turned on");
}

function ledOff(ledNum, boardNum) {
	var e = boardNum.find("#" + names[ledNum - 2]);
	e.setFill(offColor);
	led[ledNum] = 0;
	//console.log(names[ledNum - 2] + " turned off");
}

function changeScene(sceneNum) {
	currentSceneId = sceneNum;	
}



main();

mainBoardLayer.add(board);
mainBoardLayer.add(boardScene1);
mainBoardLayer.add(sceneTitle);
editStage.add(editSequencesLayer);
mainStage.add(mainBoardLayer);


</script>
</body>
</html>
